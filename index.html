<!DOCTYPE html>
<!-- Uros Petrevski, Drasko Draskovic, Angelo Chiacchio, Nodesign.net 2013 -->
<html>
<head>
	<title>Weio</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Bootstrap -->
	<link href="bootstrap/less/bootstrap.css" rel="stylesheet" type="text/css">
	<script src="http://code.jquery.com/jquery.js"></script>
	<script src="bootstrap/js/bootstrap.min.js"></script>
	<script src="bootstrap/js/bootstrap-collapse.js"></script>
	<script src="bootstrap/js/bootstrap-transition.js"></script>
	<script src="bootstrap/js/bootstrap-modal.js"></script>

	<!-- Font awesome -->
	<link rel="stylesheet" href="Font-Awesome/css/font-awesome.min.css">

	<!-- Pure JS templating engine -->
	<script src="js/pure.js"></script>

	<!-- Ace code editor engine -->
	<script src="ace/ace.js" type="text/javascript" charset="utf-8"></script>

	<script>
	// Get windows size, get number of collapse elements and calculate maximum height to fill the column
	var viewportHeight = $(window).height();

	// Global function. Can be recalled when adding a new stripe to recalculate max height value
	function update_height() {
		var numRows = $('.codebox').length;
		var finalheight = viewportHeight - (numRows * 40) - 60;
		var widgetheight = viewportHeight - 140;
		$('.code_wrap').css('min-height', finalheight);
		$('.fullheight').css('height', widgetheight);
	}

	// ace code editors are stored in this array
	var editors = [];

	// this is variable that selects correct index when code strips are manipulated
	var selectedId = -1;

	// this variable stores compiled template that can be rendered with JSON file
	// to re-render just call renderTree(), compilation occurs only one inside
	// ready function
	var compiledTree;

	// this variable stores compiled template that can be rendered with JSON file
	// to re-render just call renderEditor(), compilation occurs only one inside
	// ready function
	var compiledEditor;
	
	// this variable stores currentely focused strip index in editorData.editors array
	var focusedOne = "weio_main.py";
	
	// this variable decide if file will be saved in closing procedure
	var dontSave = false;


	// first initialization and compilation of templates, compilation only occurs
	// once, here.
	// function update_height() is called to recalculate strip dimensions
	// it has to be recalled each time change occurs

	$(document).ready(function () {
		
	
		// EDITOR ZONE
		update_height();
		compiledEditor = $('div.accordion').compile(directiveEditors);
		renderEditors();
		insertEditors();
		
		collapseAllExceptFocusedOne();
		
		// FILE TREE SIDEBAR ZONE
		compiledTree = $('ol.tree').compile(directiveFileTree);
		renderFileTree();

		$(window).resize(function() {
			update_height();
		});
	});

	// JSON file, entering point for editors
	var editorData = {
		editors:[
		{name:"weio_main.py", id:"0", type : "python", data : "a = 10"}
		]
	};
	
	// JSON file, entering point for tree
	var fileTreeData = {
		tree:[
		{name:"weio_main.py", id:"0", type : "python"},
		{name:"index.html", id:"1", type : "html"},
		{name:"test.py", id:"2", type : "python"},
		{name:"new.py", id:"3", type : "python"}
		]
	};

	
	// this is directive for templating editors with Pure JS
	var directiveEditors = {
		'div.accordion-group' :{
			'editor<-editors' : {
				'a.accordion-toggle' : 'editor.name',
				'a.accordion-toggle@href' : function getter(arg) {return '#'+ arg.item.id;},
				'div.accordion-body@id' : 'editor.id',
				'div.editor@id' : 'editor.name',

				// modals
				'#closeButton@onclick' : function getter(arg) {return "prepareToClose('" + arg.item.name + "')"},
				'h3.removeModalPhrase' : function getter(arg) {return 'Close file ?';},
				'p.removeModalPhrase' : function getter(arg) {return 'Do you want to save the changes you made in the current document ?';},
				'button.btn-primary@onclick' : function getter(arg) {dontSave = false; return "saveAndClose()"},
				'#dontSave@onclick' : function getter(arg) {dontSave = true; return "saveAndClose()";}
			}

		}
	};
	
	// this is directive for templating tree with Pure JS
	var directiveFileTree = {
		'li.file' :{
			'file<-tree' : {
				'a@onclick' : function getter(arg) {return 'addNewStrip("' + arg.item.name + '")';},
				'a' : 'file.name'
			}
		}
	};

	/* Example for return function use in templating
	'div.accordion-inner' : function makeEditorDiv(arg) {
	//console.log(arg.item.name); // don't delete cos this shit is not documented
	//console.log(arg.items);
	return '<div class="editor" id="' + arg.item.name  + '"></div>';}
	*/
	
	// This function collapse all strips except one, that is focused. focusedOne is variable that stores
	// focused strip index in editorData.editors array
	function collapseAllExceptFocusedOne() {
		
		for (var editor in editorData.editors) {
			if (editorData.editors[editor].name!=focusedOne) {
				var name = editorData.editors[editor].id;
				$('#' + name).collapse("hide");
			} 
		}
		
	}
	
	// call this function each time when change occurs in editors that has to be rendered
	function renderEditors() {
		$('div.accordion').render(editorData, compiledEditor);
	}
	
	// call this function each time when change occurs in tree that has to be rendered
	function renderFileTree() {
		$('ol.tree').render(fileTreeData, compiledTree);
	}

	// this function implements ace editors and dispach data inside empty strips
	function insertEditors() {

		for (var editor in editorData.editors) {
			//console.log(editorData.editors[editor].name);
			var e = ace.edit(editorData.editors[editor].name); // attach to specific #id
			e.setTheme("ace/theme/textmate"); // design theme
			e.getSession().setMode("ace/mode/" + editorData.editors[editor].type); // editor language (html, python, css,...)
			e.setValue(editorData.editors[editor].data); // code to be insered in editor
			editors.push(e); // add editor to array of editors
		}
	}

	// this function selects name of editor and strip that will be used to close it
	function prepareToClose(name) {
		selectedId = name;
	}

	// This function is called from modal view, it's role is to save file to the server and
	// to close strip. Strip is destroyed and new render is necessary
	function saveAndClose() {
		console.log("closing ");
		if (selectedId!=-1) {
			// TODO save function goes here
			if (dontSave==false) {
				// save here
			} 
			var index;

			// find element to kill
			for (index=0; index<editorData.editors.length; index++) {
				if (editorData.editors[index].name==selectedId) {
					//console.log("matching index " + index);

					// kill element in editor
					editors.splice(selectedId, 1);

					// kill element in JSON
					editorData.editors.splice(index, 1);

					// render changes to HTML
					update_height();
					renderEditors();
					insertEditors();
					collapseAllExceptFocusedOne();
					break;
				}
			}


		}

		selectedId = -1;
	}
	
	function addNewStrip(filename) {
		
		var newData;

		for (var file in fileTreeData.tree) {
			if (fileTreeData.tree[file].name==filename) {
				newData = fileTreeData.tree[file];
				break;
			}
		}
		
		// check if file is already opened
		var exists = false;
		for (var editor in editorData.editors) {
			if (newData.name==editorData.editors[editor].name) {
				exists = true;
				break;
			} else {
				exists = false;
			}
		}
		
		// if file don't exists in the list than add it
		if (exists==false) {
	    	editorData.editors.push(newData);
	
			// render changes to HTML
			renderEditors();
			update_height();
			insertEditors();
		} 
		
		// in every case, put focus on that file
		focusedOne = newData.name;
		collapseAllExceptFocusedOne();
		
	
	}

	</script>
</head>
<body>

	<div id="sidebar"><h1>Weio</h1>
		<a id="play">Execute</a>
		<div id="monitor">
			<aside id="status">ON</aside>
			<aside>Weio 0.5</aside>
			<a id="parameters">Parameters</a>
		</div>

<!-- FILE TREE TEMPLATE STARTS HERE -->
		<ol class="tree">
			<li>
				<label for="folder1">my Awesome Project</label> <input type="checkbox" id="folder1" /> 
				<ol>
					<li class="file">
						
						<a></a>
					</li>
				</ol>
			</li>
		<ol>
		
<!-- FILE TREE TEMPLATE ENDS HERE -->	


	
	</div id="sidebar">

	<div id="main_container">
		<div id="coding_zone">

<!-- EDITOR TEMPLATE STARTS HERE -->
			<div class="accordion" id="accordion2">
				<div class="accordion-group" >

					<div class="accordion-heading" id="template">
						<a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseOne">
						</a>

						<!-- Button to trigger modal -->

						<a href="#closeFileModal" role="button"id="closeButton" data-toggle="modal" ><i class="icon-remove"></i></a>
						<a href="#saveFile" role="button"id="saveButton" data-toggle="modal"><i class="icon-signin"></i></a>

						<!-- Close Editor Modal -->
						<div id="closeFileModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
							<div class="modal-header">
								<button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="icon-remove"></i></button>
								<h3 class = "removeModalPhrase" id="myModalLabel"></h3>
							</div>
							<div class="modal-body">
								<p class = "removeModalPhrase"></p>
								<p>Your changes will be lost if you don't save them</p>
							</div>
							<div class="modal-footer">
								<button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
								<button class="btn" id = "dontSave" data-dismiss="modal" aria-hidden="true">Don't save</button>
								<button class="btn btn-primary" data-dismiss="modal" aria-hidden="true">Save</button>
							</div>
						</div>
						<!-- Close Editor Modal  END-->

					</div>
					<div class="accordion-body collapse in codebox" id="collapseOne">
						<div class="accordion-inner code_wrap">
							<div class="editor"></div>
						</div>
					</div>
				</div>
			</div>	

<!-- EDITOR TEMPLATE ENDS HERE -->		

		</div id="coding_zone">
	</div id="main_container">
	
</body>
</html>